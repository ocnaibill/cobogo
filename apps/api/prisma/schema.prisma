generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Auth & Users ---

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  passwordHash  String    // Lembre-se: Nunca salve senha pura
  avatar        String?
  role          Role      @default(USER)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  projects      Project[]
}

enum Role {
  USER
  ADMIN
}

// --- Core Domain ---

model Project {
  id            String    @id @default(uuid())
  name          String    @unique // Slug do projeto (ex: 'meu-blog')
  description   String?
  
  // Configurações do Git
  repositoryUrl String
  branch        String    @default("main")
  
  // Configurações do Container
  buildCommand  String?   // "npm run build"
  startCommand  String?   // "npm start"
  nodeVersion   String    @default("18")
  internalPort  Int       @default(3000)
  
  // Configurações de Rede
  domain        String?   // Domínio customizado (ex: app.com.br)
  isPublic      Boolean   @default(true)

  userId        String
  user          User      @relation(fields: [userId], references: [id])
  
  deployments   Deployment[]
  variables     EnvVariable[] // Variáveis de ambiente

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model EnvVariable {
  id        String   @id @default(uuid())
  key       String
  value     String   // Criptografado (AES-256)
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Deployment {
  id            String   @id @default(uuid())
  status        Status   @default(QUEUED)
  
  commitHash    String?
  commitMessage String?
  
  logsPath      String?  // Caminho para o arquivo de log no disco (não salvar log no banco!)
  
  startedAt     DateTime @default(now())
  finishedAt    DateTime?
  
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id])
}

enum Status {
  QUEUED
  BUILDING
  LIVE
  FAILED
}
